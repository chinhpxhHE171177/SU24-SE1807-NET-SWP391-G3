<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Stacked Downtime Chart with Vertical Tooltips</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f4f4f4;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        canvas {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            /* Responsive width */
            margin-bottom: 20px;
        }

        /* Custom tooltip container */
        .chart-tooltip {
            display: flex;
            position: absolute;
            background: #ffffff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 10;
            flex-direction: column;
            /* Stack items vertically */
        }

        /* Individual tooltip item */
        .tooltip-item {
            padding: 8px;
            border: 1px solid #ddd;
            margin: 2px 0;
            /* Margin for vertical spacing */
            width: 120px;
            /* Fixed width for consistency */
            background-color: rgba(255, 255, 255, 0.9);
            /* Slightly transparent background */
            border-radius: 4px;
            transition: background-color 0.2s;
            /* Smooth transition on hover */
        }

        /* Tooltip item hover effect */
        .tooltip-item:hover {
            background-color: rgba(240, 240, 240, 1);
        }

        /* Label styling */
        .tooltip-label {
            font-weight: bold;
            /* Bold text for labels */
        }
    </style>
</head>

<body>
    <canvas id="stackedDowntimeChart" width="800" height="400"></canvas>

    <script>
        const labels = ['Downtime Metrics'];
        const downtimeData = {
            'Dừng ngắn': { duration: 120, count: 10, color: 'rgba(255, 99, 132, 0.7)', percentage: (120 / 365 * 100).toFixed(1) },
            'Dừng dài': { duration: 90, count: 8, color: 'rgba(54, 162, 235, 0.7)', percentage: (90 / 365 * 100).toFixed(1) },
            'Phế phẩm': { duration: 60, count: 6, color: 'rgba(255, 206, 86, 0.7)', percentage: (60 / 365 * 100).toFixed(1) },
            'Đổi mã, Thay dao': { duration: 30, count: 4, color: 'rgba(75, 192, 192, 0.7)', percentage: (30 / 365 * 100).toFixed(1) },
            'Đầu cuối ca': { duration: 45, count: 3, color: 'rgba(153, 102, 255, 0.7)', percentage: (45 / 365 * 100).toFixed(1) },
            'Ngoài ra': { duration: 20, count: 2, color: 'rgba(255, 159, 64, 0.7)', percentage: (20 / 365 * 100).toFixed(1) }
        };
        const efficiency = 85;

        const datasetArray = Object.keys(downtimeData).map(type => ({
            label: type,
            data: [downtimeData[type].duration],
            backgroundColor: downtimeData[type].color,
            stack: 'downtime',
            barThickness: 40,
            borderRadius: 8
        }));

        // Add efficiency as a bar
        datasetArray.push({
            label: 'Efficiency (%)',
            type: 'line',
            data: [efficiency],
            backgroundColor: 'rgba(75, 192, 192, 0.5)', // Different color for visibility
            barThickness: 40,
            yAxisID: 'efficiencyAxis',
            borderRadius: 8 
        });

        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasetArray
            },
            options: {
                scales: {
                    x: {
                        stacked: true,
                        title: { display: true, text: 'Downtime Summary' }
                    },
                    downtimeAxis: {
                        type: 'linear',
                        position: 'left',
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Downtime Duration (min)' }
                    },
                    efficiencyAxis: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        title: { display: true, text: 'Efficiency (%)' },
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    tooltip: {
                        enabled: false,
                        external: function (context) {
                            const tooltipModel = context.tooltip;
                            let tooltipEl = document.getElementById('chart-tooltip');

                            if (!tooltipEl) {
                                tooltipEl = document.createElement('div');
                                tooltipEl.id = 'chart-tooltip';
                                tooltipEl.classList.add('chart-tooltip');
                                document.body.appendChild(tooltipEl);
                            }

                            if (tooltipModel.opacity === 0) {
                                tooltipEl.style.opacity = 0;
                                return;
                            }

                            tooltipEl.innerHTML = '';
                            tooltipModel.dataPoints.forEach(dp => {
                                const typeName = dp.dataset.label;
                                if (downtimeData[typeName]) { // Downtime dataset
                                    const downtime = downtimeData[typeName];

                                    const durationTooltip = document.createElement('div');
                                    durationTooltip.classList.add('tooltip-item');
                                    durationTooltip.innerHTML = `<span class="tooltip-label">Duration:</span> ${downtime.duration} min`;
                                    tooltipEl.appendChild(durationTooltip);

                                    const countTooltip = document.createElement('div');
                                    countTooltip.classList.add('tooltip-item');
                                    countTooltip.innerHTML = `<span class="tooltip-label">Count:</span> ${downtime.count}`;
                                    tooltipEl.appendChild(countTooltip);

                                    const percentageTooltip = document.createElement('div');
                                    percentageTooltip.classList.add('tooltip-item');
                                    percentageTooltip.innerHTML = `<span class="tooltip-label">Percentage:</span> ${downtime.percentage}%`;
                                    tooltipEl.appendChild(percentageTooltip);
                                } else if (typeName === 'Efficiency (%)') { // Efficiency dataset
                                    const efficiencyTooltip = document.createElement('div');
                                    efficiencyTooltip.classList.add('tooltip-item');
                                    efficiencyTooltip.innerHTML = `<span class="tooltip-label">Efficiency:</span> ${efficiency}%`;
                                    tooltipEl.appendChild(efficiencyTooltip);
                                }
                            });

                            const position = context.chart.canvas.getBoundingClientRect();
                            tooltipEl.style.opacity = 1;
                            tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                            tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                        }
                    }
                }
            }
        };

        const stackedDowntimeChart = new Chart(
            document.getElementById('stackedDowntimeChart'),
            config
        );
    </script>

</body>

</html>